{% include "OPNsense/ProxyUserACL/acls.conf" %}

{% extends "OPNsense/ProxyUserACL/base.conf" %}

{% block set_rule %}
{% do rule.append("HTTPAccesses.HTTPAccess") %}
{% endblock %}

{% block print_rule %}
{% if Users == [] %}
{%      if access|length == 1 %}
{%          do access.append("all") %}
{%      endif %}
{%      if ACL.Mimes != null %}
http_reply_access {{ access|join(" ") }} mimes_rep_{{ helpers.getUUID(ACL.Mimes).id }}
{%      endif %}
{%          if helpers.exists('OPNsense.proxy.forward.icap.enable') and OPNsense.proxy.forward.icap.enable == '1' %}
adaptation_access response_mod {{ access|join(" ") }} {{ mimes_req_|join(" ") }}
adaptation_access request_mod  {{ access|join(" ") }} {{ mimes_req_|join(" ") }}
{%		    endif %}
http_access {{ access|join(" ") }} {{ mimes_req_|join(" ") }}
{% else %}
{%      for User in Users %}
{%          if ACL.Mimes != null %}
http_reply_access {{ access|join(" ") }} mimes_rep_{{ helpers.getUUID(ACL.Mimes).id }} {{ User }}
{%          endif %}
{%          if helpers.exists('OPNsense.proxy.forward.icap.enable') and OPNsense.proxy.forward.icap.enable == '1' %}
adaptation_access response_mod {{ access|join(" ") }} {{ mimes_req_|join(" ") }} {{ User }}
adaptation_access request_mod  {{ access|join(" ") }} {{ mimes_req_|join(" ") }} {{ User }}
{%		    endif %}
http_access {{ access|join(" ") }} {{ mimes_req_|join(" ") }} {{ User }}
{%      endfor %}
{% endif %}
{% endblock %}

{% block append_black scoped %}
{% do access.append(ACL.Black) %}
{% endblock %}
